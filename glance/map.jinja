{% set glance=salt["grains.filter_by"]({
  "Debian":{
    "name": "glance",
    "pkg": ['glance', 'glance-api', 'glance-registry', 'glance-common'],
    "service": ['glance-api', 'glance-registry'],
    "client_pkg": "python-glanceclient",
  },
  "RedHat":{
    "name": "glance",
    "pkg": "openstack-glance",
    "service": ['openstack-glance-api', 'openstack-glance-registry'],
    "client_pkg": "python-glanceclient",
  },
  "default":{
    "name": "glance",
    "pkg": ['glance', 'glance-api', 'glance-registry', 'glance-common'],
    "service": ['glance-api', 'glance-registry'],
    "client_pkg": "python-glanceclient",
  }
  },merge=salt["pillar.get"]("glance:lookup")) %}

# Set the glance-api default config
{%- set glance_api_config = {
  "DEFAULT": {
    "debug": "false",
    "verbose": "false",
    "default_store": "file",
    "known_stores": "glance.store.filesystem.Store",
    "log_file": "/var/log/glance/api.log",
    "bind_host": "0.0.0.0",
    "bind_port": "9292",
    "registry_host": "0.0.0.0",
    "registry_port": "9191",
    "notifier_strategy": "rabbit",
    "rabbit_host": salt["pillar.get"]("glance:conf:DEFAULT:rabbit_host", "localhost"),
    "rabbit_port": "5672",
    "rabbit_userid": "guest",
    "rabbit_password": salt["pillar.get"]("glance:conf:DEFAULT:rabbit_password", "guest"),
    "filesystem_store_datadir": "/var/lib/glance/images/",
    "image_cache_dir": "/var/lib/glance/image-cache/",
  },
  "database": {
    "connection": "mysql://glance:" + salt["pillar.get"]("glance:mysql:password") + "@" + salt["pillar.get"]("glance:mysql:ip","localhost") + "/glance?charset=utf8",
  },
  "keystone_authtoken": {
    "auth_host": salt["pillar.get"]("glance:keystone:internal_ip", "localhost"),
    "auth_port": "35357",
    "auth_protocol": "http",
    "admin_tenant_name": "service",
    "admin_user": "glance",
    "admin_password": salt["pillar.get"]("glance:keystone:user:password"),
  },
  "paste_deploy": {
    "flavor": "keystone+cachemanagement",
  }
} %}

# Set the glance-registry default config
{%- set glance_reg_config = {
  "DEFAULT": {
    "debug": "false",
    "verbose": "false",
    "bind_host": "0.0.0.0",
    "bind_port": "9191",
    "log_file": "/var/log/glance/registry.log",
  },
  "database": {
    "connection": "mysql://glance:" + salt["pillar.get"]("glance:mysql:password") + "@" + salt["pillar.get"]("glance:mysql:ip","localhost") + "/glance?charset=utf8",
  },
  "keystone_authtoken": {
    "auth_host": salt["pillar.get"]("glance:keystone:internal_ip", "localhost"),
    "auth_port": "35357",
    "auth_protocol": "http",
    "admin_tenant_name": "service",
    "admin_user": "glance",
    "admin_password": salt["pillar.get"]("glance:keystone:user:password"),
  },
  "paste_deploy": {
    "flavor": "keystone",
  }
} %}

{% for section, value in salt["pillar.get"]("glance:api-config").iteritems() %}
  {% if not glance_api_config.has_key(section) %}
    {% do glance_api_config.update({ section:{} }) %}
  {% endif %}
  {% do glance_api_config[section].update(value) %}
{% endfor %}

{% for section, value in salt["pillar.get"]("glance:reg-config").iteritems() %}
  {% if not glance_reg_config.has_key(section) %}
    {% do glance_reg_config.update({ section:{} }) %}
  {% endif %}
  {% do glance_reg_config[section].update(value) %}
{% endfor %}

{#- vim:ft=sls
-#}
